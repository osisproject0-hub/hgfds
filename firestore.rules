
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    //----------------------------------------------------------------------
    // Helper Functions
    //----------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Validates if the requesting user's UID matches the provided userId.
     * This is the foundation of the user-ownership model.
     * @param userId The user ID to check against the authenticated user.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the authenticated user has an 'Admin' or 'Super Admin' role.
     * This function performs a read on the user's own document to fetch their role.
     */
    function isAdmin() {
      let userRole = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
      return isSignedIn() && (userRole == 'Admin' || userRole == 'Super Admin');
    }

    //----------------------------------------------------------------------
    // Public Read-Only Collections (Admin-Managed)
    //----------------------------------------------------------------------

    /**
     * @description Manages vocational programs. Publicly readable by anyone, but
     *   only administrators can create, update, or delete entries.
     * @path /vocationalPrograms/{vocationalProgramId}
     */
    match /vocationalPrograms/{vocationalProgramId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Manages news articles. Publicly readable by anyone, but
     *   only administrators can create, update, or delete articles.
     * @path /newsArticles/{newsArticleId}
     */
    match /newsArticles/{newsArticleId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Manages school events. Publicly readable by anyone, but
     *   only administrators can create, update, or delete events.
     * @path /events/{eventId}
     */
    match /events/{eventId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Manages gallery albums. Publicly readable by anyone, but
     *   only administrators can create, update, or delete albums.
     * @path /galleryAlbums/{galleryAlbumId}
     */
    match /galleryAlbums/{galleryAlbumId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }

    /**
     * @description Manages student applications. Anyone can create (submit) an application.
     *  Only admins can read, update, or delete them. This enables a global admin view.
     * @path /applications/{applicationId}
     */
    match /applications/{applicationId} {
      allow create: if true;
      allow read, update, delete: if isAdmin();
    }

    /**
     * @description Manages contact form submissions. Anyone can submit a message.
     *  Only admins can read the messages. Deletion is restricted for archival purposes.
     * @path /contactMessages/{contactMessageId}
     */
    match /contactMessages/{contactMessageId} {
      allow create: if true;
      allow read, list: if isAdmin();
      allow update, delete: if false; // Messages are immutable
    }

    //----------------------------------------------------------------------
    // User-Specific Collections
    //----------------------------------------------------------------------

    /**
     * @description Manages user profile data and roles. A user can read their own
     *   profile. Only admins can list, create, update or delete user profiles.
     *   Listing all users is restricted to admins for privacy.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list, create, update, delete: if isAdmin();
    }
  }
}

    